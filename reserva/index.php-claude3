<?php
session_start();
$DEBUG = False;

include('../../php-require/phpqrcode.php');
require('../../php-require/mysql-elfollon.php');
require('helpers.php');
require('settings.php');
?>

<!DOCTYPE html>
<html lang="es">
<head>
<title><?php echo getEventName(); ?> - Pe√±a "El Foll√≥n" <?php echo getEventYear(); ?></title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="stylesheet" href="css/main.css">

<?php
$BASE_URL = getProtocol() . "://" . $_SERVER['SERVER_NAME'];
function getAssignedGroup($conn) {
  $stmt = $conn->prepare("SELECT gid FROM invitaciones WHERE uid=?");
  $stmt->bind_param("s", $_SESSION["uid"]);
  $result = $stmt->execute();
  $result = $stmt->get_result();
  if ($result->num_rows > 0) {
    return $result->fetch_row()[0];
  }
  return NULL;
}

function getGroupNumber($conn, $gid) {
  $stmt = $conn->prepare("SELECT id FROM grupos WHERE gid=?");
  $stmt->bind_param("s", $gid);
  $stmt->execute();
  $result = $stmt->get_result();
  return $result->fetch_row()[0];
}

function getGroupSize($conn, $gid) {
  $stmt = $conn->prepare("SELECT COUNT(*) FROM `invitaciones` WHERE gid=?");
  $stmt->bind_param("s", $gid);
  $stmt->execute();
  $result = $stmt->get_result();
  return $result->fetch_row()[0];
}

function getGroupTable($conn, $gid) {
  $stmt = $conn->prepare("SELECT mesa FROM `grupos` WHERE gid=?");
  $stmt->bind_param("s", $gid);
  $stmt->execute();
  $result = $stmt->get_result();
  $table = $result->fetch_row()[0];
  return $table;
}

function getGroupTableSeats($conn, $gid) {
  $stmt = $conn->prepare("SELECT asiento FROM `grupos` WHERE gid=?");
  $stmt->bind_param("s", $gid);
  $stmt->execute();
  $result = $stmt->get_result();
  $first_seat = $result->fetch_row()[0];
  if ($first_seat == null) {
    return null;
  }
  $seat_n = getGroupSize($conn, $gid);
  return range($first_seat, $first_seat + ($seat_n - 1));
}

function getGroupNewId($conn) {
  $max = $conn->query("SELECT MAX(id) FROM `grupos`")->fetch_row()[0];
  $count = $conn->query("SELECT COUNT(*) FROM `grupos`")->fetch_row()[0];
  if ($max == $count) {
    return $max + 1;
  } else {
    $result = $conn->query("SELECT id FROM `grupos` ORDER BY id ASC");
    $idx = 1;
    while ($id = $result->fetch_row()) {
      if ($idx != $id[0]) {
        return $idx;
      }
      $idx = $idx + 1;
    }
    return $idx;
  }
}

function getEventIsToday() {
  $date_event = getEventYear() . "-" . getEventMonthNumber() . "-" . getEventDay();
  return date("Y-m-d") == $date_event;
}

function getScanInstructions() {
  # TODO: Add animated GIF explaining how to scan a QR code can be added here
  # e.g.: <div class="scan-instructions"><img src="img/scan.gif"></div><br>
  echo '<div class="scan-instructions">
          <p>Apunta la c√°mara de tu m√≥vil al c√≥digo QR de tu invitaci√≥n</p>
          <div class="animate-pulse">üì± ‚Üí üì∑ ‚Üí üîç</div>
        </div>';
}

function setGroup($conn, $gid) {
  $stmt = $conn->prepare("UPDATE invitaciones SET gid=? WHERE uid=?");
  $stmt->bind_param("ss", $gid, $_SESSION["uid"]);
  $result = $stmt->execute();
  $conn->commit();
}

function createGroup($conn) {
  $new_gid = hash('sha1', 'El-Follon-' . $_SESSION["uid"] . '-' . date("Y-m-d H:m:s"));
  $conn->begin_transaction();
  try {
    $id = getGroupNewId($conn);
    # Insert new group
    $stmt = $conn->prepare("INSERT INTO grupos (gid, id) VALUES (?,?)");
    $stmt->bind_param("ss", $new_gid, $id);
    $stmt->execute();
    # Update invitations accordingly
    $stmt = $conn->prepare("UPDATE invitaciones SET gid=? WHERE uid=?");
    $stmt->bind_param("ss", $new_gid, $_SESSION["uid"]);
    $stmt->execute();
    $conn->commit();
  } catch (mysqli_sql_exception $exception) {
    $conn->rollback();
    echo '<div class="alert alert-danger">ERROR: Int√©ntelo de nuevo m√°s adelante.</div>';
    throw $exception;
    exit(1);
  }
}

function leaveGroup($conn) {
  $gid = getAssignedGroup($conn);
  if (getGroupSize($conn, $gid) == 1) {
    # Eliminar grupo (foreign key cascading is enabled, no need to explicitly set to NULL)
    $stmt = $conn->prepare("DELETE FROM grupos WHERE gid=?");
    $stmt->bind_param("s", $gid);
  } else {
    # Eliminar asignaci√≥n
    $stmt = $conn->prepare("UPDATE invitaciones SET gid=NULL WHERE uid=?");
    $stmt->bind_param("s", $_SESSION["uid"]);
  }
  $stmt->execute();
  $conn->commit();
}

function getPlural($n) {
  if ($n > 1) { return "s"; }
}

function getIsUserInDatabase($conn, $uid) {
  $stmt = $conn->prepare("SELECT uid FROM invitaciones WHERE uid=?");
  $stmt->bind_param("s", $uid);
  $stmt->execute();
  $result = $stmt->get_result();
  return $result->fetch_row()[0] === $uid;
}


# Sanitize inputs and guarantee valid data is received
$uid = preg_replace('/[^-a-zA-Z0-9_]/', '', filter_input(INPUT_GET, 'invitacion', FILTER_SANITIZE_URL));
if (strlen($uid) != $hashSize) {
  debugPrint("Wrong invitation hash length, ignoring<br>");
  unset($uid);
}
$join_gid = preg_replace('/[^-a-zA-Z0-9_]/', '', filter_input(INPUT_GET, 'unirse', FILTER_SANITIZE_URL));
if (strlen($join_gid) != $hashSize) {
  debugPrint("Wrong group hash length, ignoring<br>");
  unset($join_gid);
}

if (isset($uid) and getIsUserInDatabase($conn, $uid)) {
  debugPrint("Saving into SESSION uid: " . $uid);
  $_SESSION["uid"] = $uid;
} else {
  debugPrint("Unsetting uid.");
  unset($uid);
}
if (!isset($uid) and isset($_SESSION["uid"])) {
  $uid = $_SESSION["uid"];
}

$gid = getAssignedGroup($conn);
if (!is_null($gid) and isFrozen()) {
    echo "<link href=\"css/groups/" . $gid . ".css\" rel=\"stylesheet\">";
}
$gnum = getGroupNumber($conn, $gid);
$nmm = getGroupSize($conn, $gid);
$gt = getGroupTable($conn, $gid);
$gts = getGroupTableSeats($conn, $gid);
?>
</head>
<body>
<div class="header-container">
    <img src="img/logo.png" alt="Left Logo" class="logo">
    <h1><?php echo getEventName(); ?></h1>
    <img src="img/logo.png" alt="Right Logo" class="logo">
</div>

<div class="container">
  <div class="info-card">
    <div class="info-item">
      <span class="info-label">Fecha:</span>
      <span><?php echo getPrintableEventDay(); ?> de <?php echo getEventMonthText(); ?> de <?php echo getEventYear(); ?> (<?php echo getPrintableEventTime(); ?>h.)</span>
    </div>
    <div class="info-item">
      <span class="info-label">Lugar:</span>
      <span><?php echo getEventLocation(); ?></span>
    </div>

<?php
if (!$uid) {
  echo '<div class="alert alert-danger">
          <strong>ERROR:</strong> Invitaci√≥n no v√°lida.
        </div>';
  if (!isset($join_gid)) {
    echo '<div class="alert alert-info">
            Por favor, primero <strong>escanea el c√≥digo QR</strong> de la invitaci√≥n para identificarte.
          </div>';
    getScanInstructions();
    session_destroy();
    exit(1);
  }
} else {
  $stmt = $conn->prepare("UPDATE invitaciones SET last_access = NOW() WHERE uid=?");
  $stmt->bind_param("s", $uid);
  $stmt->execute();
  $stmt = $conn->prepare("SELECT label FROM invitaciones WHERE uid=?");
  $stmt->bind_param("s", $uid);
  $stmt->execute();
  $label = $stmt->get_result()->fetch_row()[0];
  $tag = ($label ? (is_numeric($label) ? "#" . $label : $label) : substr($uid, -6));
  echo '<div class="info-item">
          <span class="info-label">Invitaci√≥n:</span>
          <span>' . $tag . '</span>
        </div>';
}

debugPrint("<b>uid</b>: " . $uid . "<br>");
debugPrint("<b>_SESSION['uid']</b>: " . $_SESSION["uid"] . "<br>");
if (isset($join_gid)) { debugPrint("<b>join_gid</b>: " . $join_gid . "<br>"); }

if (!isset($_SESSION["uid"]) and isset($join_gid)) {
  echo '<div class="alert alert-warning">
          <p>Escanea el QR de la invitaci√≥n con la c√°mara de tu m√≥vil <strong>antes</strong> de utilizar el enlace para unirte a un grupo.</p>
          <p>Recuerda que debes usar el mismo dispositivo, navegador y sesi√≥n. Evita el modo privado/inc√≥gnito.</p>
        </div>';
  getScanInstructions();
  exit(1);
} elseif (isset($_SESSION["uid"]) and isset($join_gid)) {
  if ($join_gid != getAssignedGroup($conn)) {
    leaveGroup($conn);
  }
  setGroup($conn, $join_gid);
  header('Location: /');
}

if (isset($_GET['abandonar'])) {
  if (!isFrozen()) {
    leaveGroup($conn);
  }
  header('Location: /');
}

if ((isset($_GET['crear'])) and (!isFrozen())) {
  if (is_null(getAssignedGroup($conn))) {
     createGroup($conn);
  }
  header('Location: /');
}

if ($gid) {
  echo '<div class="info-item">
          <span class="info-label">Grupo:</span>
          <span>#' . $gnum . ' (' . $nmm . ' miembro' . getPlural($nmm) . ')</span>
        </div>';
}
?>
  </div><!-- Fin de info-card -->

<?php
if (!isFrozen()) {
  echo '<div class="info-card">
          <h2>Informaci√≥n importante</h2>
          <p>A la hora de empezar cada grupo tendr√° un lugar asignado en una mesa.</p>';
  if (getEventIsToday()) {
    echo '<p>A partir de las <strong>' . getMinutesBeforeTime(getPrintableEventTime(), getLimitMinutes()) . 'h</strong> escanea de nuevo tu QR para ver vuestros asientos.</p>';
  } else {
    echo '<p>Los grupos ser√°n definitivos <strong>' . getLimitMinutes() . ' minutos</strong> antes del comienzo.</p>';
  }
  echo '</div>';
} elseif (is_null($gid)) {
  echo '<div class="info-card">
          <div class="alert alert-info">
            <p>No formas parte de ning√∫n grupo de reserva y el plazo est√° ya cerrado.</p>
            <p>Por favor, dir√≠gete hacia las mesas destinadas a los socios que acuden sin reserva, all√≠ podr√©is sentaros libremente como en a√±os anteriores.</p>
          </div>
        </div>';
  exit(0);
} elseif (!is_null($gt) and !is_null($gts)) {
  echo '<div class="info-card">
          <div class="info-item">
            <span class="info-label">Mesa:</span>
            <span>' . $gt . '</span>
          </div>
          <div class="info-item">
            <span class="info-label">Asiento' . getPlural($nmm) . ':</span>
            <span>' . $gts[0];
  if ($nmm > 1) { echo "-" . $gts[$nmm-1]; }
  echo '</span>
        </div>
      </div>';
  
  echo '<div class="info-card">
          <h2>Distribuci√≥n de mesas y asientos</h2>
          <p>Vuestros asientos est√°n se√±alados en <strong style="color: red;">rojo</strong>.</p>
          <div class="distribucion">';
  include("mapa.html");
  echo '</div>
      </div>';
  exit(0);
} else {
  echo '<div class="info-card">
          <div class="alert alert-info">
            <p>Las reservas est√°n siendo asignadas, vuelve a comprobarlo escaneando el QR de tu invitaci√≥n m√°s adelante.</p>
          </div>
        </div>';
  exit(0);
}

if ($gid) {
  $url = $BASE_URL . "/?unirse=" . $gid;
  ?>
  <div class="info-card">
    <h2>Compartir grupo</h2>
    <p>Puedes invitar a otros a unirse al <strong>GRUPO <?php echo $gnum; ?></strong>:</p>

    <div class="social">
      <div id="TextoACopiar" hidden><?php echo $url; ?></div>
      <button id="BotonCopiar" class="btn btn-primary" onclick="copyOnClick()">Copiar enlace</button>
      
      <a href="whatsapp://send?text=<?php echo urlencode('Escanea el QR de tu invitaci√≥n y luego √∫nete a mi grupo desde aqu√≠: ' . $url); ?>" class="btn btn-success btn-whatsapp">
        <img alt="Compartir en WhatsApp" src="img/whatsapp.svg">
        <span class="btn-whatsapp-label">Compartir</span>
      </a>
      
      <a href="<?php echo $BASE_URL; ?>/?abandonar" class="btn btn-danger">Abandonar</a>
    </div>
  </div>

  <div id="copyMessage" class="copy-message">¬°Enlace copiado!</div>

  <script>
    function copyOnClick() {
      var codigoACopiar = document.getElementById('TextoACopiar').innerText;
      var boton = document.getElementById('BotonCopiar');
      var copyMessage = document.getElementById('copyMessage');

      navigator.clipboard.writeText(codigoACopiar).then(() => {
        boton.innerText = "¬°Copiado!";
        boton.classList.add('copiado');
        
        // Mostrar mensaje flotante
        copyMessage.classList.add('show');
        
        // Forzar actualizaci√≥n en Safari
        boton.offsetHeight;

        // Mostrar un popup en iOS si no se ve feedback
        if (navigator.userAgent.includes("Safari") && !navigator.userAgent.includes("Chrome")) {
          alert("Enlace copiado al portapapeles.");
        }

        setTimeout(() => {
          boton.innerText = "Copiar enlace";
          boton.classList.remove('copiado');
          copyMessage.classList.remove('show');
        }, 1500);
      }).catch(err => {
        console.error("Error al copiar: ", err);
        alert("Hubo un problema al copiar el enlace.");
      });
    }
  </script>
<?php } else { ?>
  <div class="info-card">
    <div class="alert alert-info">
      <p><strong>No formas parte de ning√∫n grupo</strong></p>
      <p>Puedes unirte a uno existente a trav√©s de un enlace o crear uno nuevo e invitar a otros.</p>
    </div>
    <div class="social">
      <a href="<?php echo $BASE_URL; ?>/?crear" class="btn btn-primary">Crear nuevo grupo</a>
    </div>
  </div>
<?php } ?>

</div><!-- Fin del container -->

</body>
</html>
<?php $conn->close(); ?>
